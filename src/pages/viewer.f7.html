<template>
    <div class="page" data-name="infected-quiz">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Back</span>
                    </a>
                </div>
                <div class="title-row">
                    <div class="col-100">
                        <div class="title--line-height">
                            Step
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content">
            <div class="block block-title-medium">
                <p>Activity: {{ activity }}</p>
                <p>Step: {{ step }}</p>
                <p>title: {{ activity_title }}</p>
                <p>description: {{ activity_description }}</p>
                <p>options: {{ options }}</p>
            </div>
            <div class="list no-hairlines" id="quiz">
                <ul>
                    {{#each options}}
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="option" value="{{ value }}" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-text quiz__text">
                                    ({{ value }}) {{ desc }}
                                </div>
                            </div>
                        </label>
                    </li>
                    {{/each}}
                </ul>

                <div class="block display-flex flex-direction-column justify-content-center align-content-space-around">
                    {{#if show_results}}
                        <a href="/" class="button button-fill button-large margin-top">Finalizar</a>
                    {{else}}
                        <a class="button button-fill button-large margin-top" @click="continue">Continuar</a>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</template>

<script>
    function isValidStep(step) {
        return parseInt(step) >= 0;
    }

    export default {
        data: function() {
            var app = this.$app;
            var step = this.$route.params.step;
            var activity = this.$route.params.activity;
            var data = {
                step: step,
                activity: activity,
                title: '?',
                description: '?',
                value: '?',
                desc: '?',
                options: [],
                results: {},
                show_results: false,
                results_text: '',
            };

            if(app.data.activities[activity] == undefined) {
                console.error('Unknown activity with name: ' + activity);
            }

            if(!isValidStep(step)) {
                console.error('invalid step: ' + step);
            }

            var specs = app.data.activities[activity];

            specs.forEach(item => {
                if(!isValidStep(item.step)) {
                    console.error('invalid step: ' + item.step);
                    return;
                }

                if(item.type == 'info' && item.step == 0) {
                    // Convention that item in step 0 describes the whole thing
                    data.activity_title = item.value;
                    data.activity_description = item.desc;
                }

                if(item.step != step) {
                    // this entry is not useful right now
                    return;
                }

                if(item.type == 'op') {
                    data.options.push(item);

                } else if(item.type == 'result') {
                    data.results[item.value] = item.desc;

                } else if(item.type == 'info') {
                    data.value = item.value;
                    data.desc = item.desc;

                } else {
                    console.warn('Entry type not handled: ', item.type);
                }
            });

            if(step != 0 && data.options.length == 0) {
                // No more options to choose from, so it's the end.
                data.show_results = true;
                data.results_text = 'Something very byg';
            }

            return data;
        },

        methods: {
            continue: function() {
                var app = this.$app;
                var step = this.$route.params.step;
                var activity = this.$route.params.activity;
                
                let selections = document.querySelectorAll("#quiz input[type='checkbox']:checked");

                if(app.data.answers[step] == undefined) {
                    app.data.answers[step] = [];
                }

                if (selections.length == 0 && step != 0) {
                    this.$app.dialog.alert("Selecione ao menos uma das opções anteriores.", "Coronavírus Chapecó");
                    return;
                }

                selections.forEach(item => {
                    app.data.answers[step].push(item.value);
                });

                step++;
                this.$router.navigate("/viewer/" + activity + "/" + step);
            },
        },

        on: {
            pageInit: function() {
                var app = this.$app;
                var step = this.$route.params.step;
                var activity = this.$route.params.activity;

                if(app.data.activities[activity] == undefined) {
                    console.error('Unknown activity with name "' + activity + '"', app.data.activities);
                }

                if(step == 0) {
                    app.data.answers = [];
                    console.log('Starting activity: ', activity);
                }
            }
        }
    };
</script>

<style>
    .card__icon {
        height: 55px;
    }

    .quiz__text {
        color: #1e2f42;
        font-weight: bold;
    }

    .title--line-height {
        line-height: 1.3rem;
    }

    .card-footer--position-initial {
        position: initial;
    }
</style>
